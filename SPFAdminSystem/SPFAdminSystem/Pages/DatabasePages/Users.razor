@page "/users"
@attribute [Authorize(Roles = "Admin")];
@using SPFAdminSystem.Database;
@using SPFAdminSystem.Database.UserFiles
@using BCrypt.Net
@inject IUserData _db
@inject IJSRuntime js

    <PopupModal user=@curUser showModal=@showModal/>

<h5>All Users</h5>
@if (users is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th style="text-align: center;">UserId</th>
                <th style="text-align: center;">UserName</th>
                <th style="text-align: center;">Password</th>
                <th style="text-align: center;">Full Name</th>
                <th style="text-align: center;">Role</th>
                <th style="text-align: center;">Delete User</th>

            </tr>
        </thead>
        <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td style="text-align: center;">@user.UserId</td>
                    <td style="text-align: center;">@user.UserName</td>
                    <td style="text-align: center;">****************</td>
                    <td style="text-align: center;">@user.FullName</td>
                    <td style="text-align: center;">@user.Role</td>
                    <td style="text-align: center;">
                        <button style="all: unset; cursor: pointer;" @onclick="() => showDeleteModal(user)">
                            <span class="oi oi-trash"></span>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h3>Add User</h3>
    <input @bind=userName @bind:event="oninput" type="text" placeholder="UserName" required />
    <input @bind=password @bind:event="oninput" type="text" placeholder="Password" required />
    <input @bind=fullName @bind:event="oninput" type="text" placeholder="Full Name" required />



    <label for="role">User Role:</label>
    <select name="role" id="role" @bind=role>
        <option value="Employee">employee</option>
        <option value="Admin">admin</option>
    </select>


    <button onclick="@addUser">add new user</button>
    <button onclick="@getUserByName">Test Get User</button>
}   

@code {
    // Variables for input bind
    public string? userName { get; private set; }
    public string? password { get; private set; }
    public string? fullName { get; private set; }
    public string? role { get; private set; } = "Employee";
    public string? showModal { get; set; } = "visually-hidden";
    public User curUser = new User { UserName = "N/A", FullName = "N/A", Role = "N/A", UserId = 1337 };
    private List<User> users = new();
    public bool modalDisplay { get; private set; } = false;

    protected override async Task OnInitializedAsync()
    {
        users = await _db.GetUsers();
    }

    public async Task showDeleteModal(User user)
    {
        curUser = user;
        showModal = null;
    }

    public async Task addUser()
    {

        User u = new User();
        u.UserName = userName;
        u.Password = BCrypt.HashPassword(password);
        u.FullName = fullName;
        u.Role = role;

        await _db.InsertUser(u);

        users.Add(u);
        Console.WriteLine("User Added");
    }

    public async Task getUserByName() {
        try 
        {
            /*  UserTest = await _db.GetUserByName("fdsafdsa");*/
        } catch(Exception)
        {
            await js.InvokeVoidAsync("alert", "Error: User Not Found");
        }
    }
}

